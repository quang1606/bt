<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>AdminLTE 3 | Dashboard</title>

    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback"/>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="/admin-assets/plugins/fontawesome-free/css/all.min.css"/>

    <!-- Theme style -->
    <link rel="stylesheet" href="/admin-assets/dist/css/adminlte.min.css"/>
    <!-- overlayScrollbars -->
    <link rel="stylesheet" href="/admin-assets/plugins/overlayScrollbars/css/OverlayScrollbars.min.css"/>

    <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/highlight.js/latest/styles/github.min.css"/>

    <link rel="stylesheet" href="/admin-assets/plugins/select2/css/select2.min.css"/>
    <link rel="stylesheet" href="/admin-assets/dist/css/style.css">
</head>

<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">
    <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <!-- Left navbar links -->
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
            </li>
        </ul>

        <!-- Right navbar links -->
        <ul class="navbar-nav ml-auto">

            <!-- Notifications Dropdown Menu -->
            <li class="nav-item dropdown">
                <a class="nav-link py-0 d-flex align-items-center" data-toggle="dropdown" href="#">
                    <div class="user-panel">
                        <div class="image">
                            <img src="../../dist/img/user2-160x160.jpg" class="img-circle border" alt="User Image">
                        </div>
                    </div>
                </a>

                <div class="dropdown-menu dropdown-menu-sm dropdown-menu-right">
                    <a href="#" class="dropdown-item">
                        <span class="text-muted">Trang chủ</span>
                    </a>
                    <a href="#" class="dropdown-item">
                        <span class="text-muted">Đăng xuất</span>
                    </a>
                </div>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-widget="fullscreen" href="#" role="button">
                    <i class="fas fa-expand-arrows-alt"></i>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Main Sidebar Container -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <!-- Brand Logo -->
        <a href="./index.html" class="brand-link">
            <img src="dist/img/AdminLTELogo.png" alt="AdminLTE Logo" class="brand-image img-circle elevation-3"
                 style="opacity: 0.8"/>
            <span class="brand-text font-weight-light">Admin</span>
        </a>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Sidebar Menu -->
            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu"
                    data-accordion="false">
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <i class="nav-icon fas fa-chart-pie"></i>
                            <p>
                                Quản lý phim
                                <i class="right fas fa-angle-left"></i>
                            </p>
                        </a>
                        <ul class="nav nav-treeview">
                            <li class="nav-item">
                                <a href="/admin/movies" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>Danh sách phim</p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="/admin/movies/create" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>Tạo phim</p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="./create.html" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>Tạo bài viết</p>
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <i class="nav-icon fas fa-tree"></i>
                            <p>
                                Quản lý user
                                <i class="fas fa-angle-left right"></i>
                            </p>
                        </a>
                        <ul class="nav nav-treeview">
                            <li class="nav-item">
                                <a href="pages/UI/general.html" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>Danh sách user</p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="pages/UI/icons.html" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>Tạo user</p>
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </nav>
        </div>
    </aside>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-12">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="#">Dashboard</a>
                            </li>
                            <li class="breadcrumb-item">
                                <a href="#">Blog</a>
                            </li>
                            <li class="breadcrumb-item active">
                                Tạo bài viết
                            </li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">

                <div class="row py-2">
                    <div class="col-6">
                        <button type="button" class="btn btn-default">
                            <i class="fas fa-chevron-left"></i> Quay lại
                        </button>
                        <button id="updateMovieBtn"
                                type="button" class="btn btn-info px-4">
                            Cập nhật
                        </button>

                    </div>

                    <div class="col-6 d-flex justify-content-end">
                        <button type="button" class="btn btn-danger px-4">
                            Xóa
                        </button>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="form-group">
                                            <label>Tên phim </label>
                                            <input type="text" class="form-control" id="title"
                                                   th:value="${movie.getName()}"/>
                                        </div>


                                        <div class="form-group">
                                            <label>Mô tả ngắn</label>
                                            <textarea id="description" class="form-control" rows="7"
                                                      th:text="${movie.getDescription()}"></textarea>

                                        </div>

                                        <div class="form-group">
                                            <label>Trailer</label>
                                            <input type="text" class="form-control" id="trailer"
                                                   th:value="${movie.getTrailer()}"/>
                                        </div>

                                        <div class="form-group">
                                            <label>Thể loại</label>
                                            <div class="select2-purple">
                                                <select class="select2 form-control" multiple="multiple" id="genres">
                                                    <!-- Hiển thị danh sách các thể loại -->
                                                    <option th:each="genre : ${genres}"
                                                            th:value="${genre.id}"
                                                            th:text="${genre.name}"
                                                            th:selected="${movie.genres.contains(genre)}">
                                                        <!-- Nội dung option (chỉ được hiển thị nếu không dùng th:text) -->
                                                    </option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label>Đạo diễn </label>
                                            <div class="select2-purple">
                                                <select class="select2 form-control" multiple="multiple" id="director">
                                                    <option th:each="directors : ${director}" th:value="${directors.id}"
                                                            th:text="${directors.getName()}"
                                                            th:selected="${movie.directors.contains(directors)}">
                                                        Java
                                                    </option>

                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>Diễn viên </label>
                                            <div class="select2-purple">
                                                <select class="select2 form-control" multiple="multiple" id="actor">
                                                    <option th:each="actor : ${actor}" th:value="${actor.id}"
                                                            th:text="${actor.getName()}"
                                                            th:selected="${movie.actors.contains(actor)}">
                                                        Java
                                                    </option>

                                                </select>
                                            </div>
                                        </div>

                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label>Quốc gia</label>
                                            <select id="country" class="form-control">
                                                <!-- Thêm option mặc định (placeholder) ở đây -->
                                                <option value="" selected disabled>-- Chọn quốc gia --</option>
                                                <!-- Các option động từ ${countries} -->
                                                <option th:each="country : ${countries}"
                                                        th:value="${country.id}"
                                                        th:text="${country.name}"
                                                        th:selected="${movie.country.id == country.id}">

                                                    <!-- Không cần nội dung bên trong khi dùng th:text -->
                                                </option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label>Trạng thái</label>
                                            <!-- Thêm thuộc tính disabled vì đây là trang chi tiết -->
                                            <select id="status" class="form-control" >
                                                <!-- Option Nháp: Được chọn nếu movie.status là false -->
                                                <!-- Giả sử value="0" vẫn đại diện cho false trong hệ thống của bạn -->
                                                <option value="0" th:selected="${movie.status == false}">
                                                    Nháp
                                                </option>
                                                <!-- Option Công khai: Được chọn nếu movie.status là true -->
                                                <!-- Giả sử value="1" vẫn đại diện cho true trong hệ thống của bạn -->
                                                <option value="1" th:selected="${movie.status == true}">
                                                    Công khai
                                                </option>
                                                <!-- Tùy chọn: Xử lý trường hợp status là null (nếu có thể) -->
                                                <option value="" disabled th:selected="${movie.status == null}" th:if="${movie.status == null}">
                                                    -- Chưa có trạng thái --
                                                </option>
                                            </select>
                                        </div>

                                     
                                        <!-- Bạn có thể thêm dòng này để kiểm tra giá trị thực tế mà Thymeleaf thấy (xóa đi sau khi debug xong) -->
                                        <div class="form-group">
                                            <label>Năm phát hành</label>
                                            <input type="text" class="form-control" id="releaseYear"
                                                   th:value="${movie.getReleaseYear()}"/>
                                        </div>
                                        <div class="form-group">
                                            <label>Loại phim</label>
                                            <!-- Thêm disabled nếu đây là trang chi tiết -->
                                            <select id="movieType" class="form-control" >
                                                <option value="" disabled th:selected="${movie.getType() == null}">-- Chọn thể loại --</option>
                                                <!-- Sử dụng #strings.equals để so sánh chuỗi an toàn hơn -->
                                                <option value="PHIM_BO" th:selected="${#strings.equals(movie.getType(), 'PHIM_BO')}">
                                                    Phim bộ
                                                </option>
                                                <option value="PHIM_LE" th:selected="${#strings.equals(movie.getType(), 'PHIM_LE')}">
                                                    Phim lẻ
                                                </option>
                                                <option value="PHIM_CHIEU_RAP" th:selected="${#strings.equals(movie.getType(), 'PHIM_CHIEU_RAP')}">
                                                    Phim chiếu rạp
                                                </option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <div class="thumbnail-preview-container mb-3" style="border: 1px dashed #ccc; min-height: 150px; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa;">
                                                <img th:src="${movie != null && movie.thumbnail != null ? movie.thumbnail : ''}"
                                                     alt="Xem trước thumbnail" id="thumbnail" style="max-width: 100%; max-height: 250px; display: block; margin: auto;"
                                                     th:styleappend="${movie == null || movie.thumbnail == null} ? 'display: none;' : ''" />
                                                <!-- Đảm bảo placeholder tồn tại -->
                                                <span id="thumbnail-placeholder" th:if="${movie == null || movie.thumbnail == null}" style="color: #6c757d;">Chưa có ảnh</span>
                                            </div>
                                            <label for="thumbnail-input" id="thumbnail-upload-label" class="btn btn-info btn-flat">
                                                <i class="fas fa-upload mr-1"></i> Chọn hoặc đổi ảnh
                                            </label>
                                            <input type="file" id="thumbnail-input" class="d-none" accept="image/*" />

                                            <!-- ======================================== -->
                                            <!-- === THÊM HOẶC KIỂM TRA CÁC DÒNG SAU === -->
                                            <!-- ======================================== -->

                                            <!-- 1. Input ẩn để lưu URL (Quan trọng nếu cần dùng URL sau này) -->
                                            <input type="hidden" id="thumbnail-url-hidden" th:value="${movie != null ? movie.thumbnail : ''}" />

                                            <!-- 2. Khu vực hiển thị trạng thái upload -->
                                            <div id="upload-status" class="mt-2" style="font-style: italic; color: #007bff;"></div>

                                            <!-- ======================================== -->
                                            <!-- =========== KẾT THÚC PHẦN THÊM ========== -->
                                            <!-- ======================================== -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-content-center mb-3">
                                <h4>Danh sách tập phim</h4>
                                <button class="btn btn-primary" data-toggle="modal" data-target="#modalEpisode">Tạo tập phim</button>
                            </div>
                            <table class="table table-bordered table-hover" id="table-episode">
                                <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Tên tập phim</th>
                                    <th style="width: 50%">Link</th>
                                    <th>Thời lượng</th>
                                    <th>Trạng thái</th>
                                    <th></th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td>1</td>
                                    <td>Tap 1</td>
                                    <td class="videoUrl" style="word-break: break-all">
                                        http://res.cloudinary.com/dchrybytt/image/upload/v1745930233/file_java_27_28/cwim3qrad2mokindunbn.png
                                    </td>
                                    <td class="duration">90</td>
                                    <td>Cong khai</td>
                                    <td>
                                        <label class="btn btn-warning btn-sm mb-0"
                                               for="input-video-1">
                                            <i class="fas fa-upload"></i>
                                        </label>
                                        <input
                                                type="file"
                                                id="input-video-1"
                                                class="d-none"
                                        >
                                        <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#modalPreview">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        <button class="btn btn-success btn-sm">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="modalPreview">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">Video Preview</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">×</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <video width="100%" controls>
                                <source src="" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="modalEpisode">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">Tao tap phim</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">×</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="form-episode">
                                <div class="form-group">
                                    <label>Tên tập phim</label>
                                    <input type="text" class="form-control" id="episodeName" name="name"/>
                                </div>
                                <div class="form-group">
                                    <label>Tập số bao nhiêu</label>
                                    <input type="text" class="form-control" id="episodeDisplayOrder" name="displayOrder"/>
                                </div>
                                <div class="form-group">
                                    <label>Trạng thái</label>
                                    <select class="form-control" id="episodeStatus" name="status">
                                        <option value="false">Ẩn</option>
                                        <option value="true">Công khai</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary">Xác nhận</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

        </section>

        <div class="modal fade" id="modal-xl" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Extra Large Modal</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">×</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>One fine body…</p>
                    </div>
                    <div class="modal-footer justify-content-between">
                        <button type="button" class="btn btn-default" data-dismiss="modal">
                            Close
                        </button>
                        <button type="button" class="btn btn-primary">
                            Save changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- jQuery -->
<script src="/admin-assets/plugins/jquery/jquery.min.js"></script>

<!-- Bootstrap 4 -->
<script src="/admin-assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>

<!-- overlayScrollbars -->
<script src="/admin-assets/plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>

<!-- AdminLTE App -->
<script src="/admin-assets/dist/js/adminlte.js"></script>

<script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>

<script src="https://cdn.jsdelivr.net/highlight.js/latest/highlight.min.js"></script>

<script src="/admin-assets/plugins/select2/js/select2.full.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script th:inline="javascript">
    let movie = [[${movie}]];
</script>
<script>
    //Initialize Select2 Elements
    $(".select2").select2();

    // Initialize editor
    const easyMDE = new EasyMDE({
        element: document.getElementById("content"),
        spellChecker: false,
        maxHeight: "500px",
        renderingConfig: {
            codeSyntaxHighlighting: true,
        },
    });
</script>
<script>
    function validateMovieData(movieData) {
        if (!movieData.name) {
            alert('Tên phim không được để trống');
            document.getElementById('title').focus();
            return false;
        }
        if (!movieData.trailerUrl) {
            alert('Trailer không được để trống');
            document.getElementById('trailer').focus();
            return false;
        }
        if (!movieData.description) {
            alert('Mô tả không được để trống');
            document.getElementById('description').focus();
            return false;
        }
        if (!movieData.releaseYear || isNaN(movieData.releaseYear)) {
            alert('Năm phát hành không được để trống hoặc không hợp lệ');
            document.getElementById('releaseYear').focus();
            return false;
        }
        if (!movieData.type) {
            alert('Loại phim không được để trống');
            document.getElementById('movieType').focus();
            return false;
        }
        if (!movieData.countryId || isNaN(movieData.countryId)) {
            alert('Quốc gia không được để trống hoặc không hợp lệ');
            document.getElementById('country').focus();
            return false;
        }
        return true;
    }
    async function handleUpdateMovie(event) {
        event.preventDefault();

        const updateBtn = document.getElementById('updateMovieBtn');
        updateBtn.disabled = true;
        updateBtn.textContent = 'Đang cập nhật...';

        // Lấy giá trị ID bộ phim cần cập nhật
        const movieId = movie.id;
        if (!movieId) {
            alert('Không tìm thấy ID phim để cập nhật');
            updateBtn.disabled = false;
            updateBtn.textContent = 'Cập nhật phim';
            return;
        }

        // Chuyển đổi dữ liệu form
        const statusValue = document.getElementById('status').value;
        const statusBoolean = statusValue === '1';

        const movieData = {
            name: document.getElementById('title').value.trim(),
            trailerUrl: document.getElementById('trailer').value.trim(),
            description: document.getElementById('description').value.trim(),
            releaseYear: parseInt(document.getElementById('releaseYear').value.trim(), 10),
            type: document.getElementById('movieType').value.trim(),
            status: statusBoolean,
            countryId: parseInt(document.getElementById('country').value.trim(), 10),
            genreIds: Array.from(document.getElementById('genres').selectedOptions).map(option => parseInt(option.value, 10)),
            actorIds: Array.from(document.getElementById('actor').selectedOptions).map(option => parseInt(option.value, 10)),
            directorIds: Array.from(document.getElementById('director').selectedOptions).map(option => parseInt(option.value, 10)),
        };
        console.log(movieData)
        console.log(movieId)
        // Validate dữ liệu
        if (!validateMovieData(movieData)) {
            updateBtn.disabled = false;
            updateBtn.textContent = 'Cập nhật phim';
            return;
        }

        try {
            // Thực hiện gọi API PUT
            const response = await axios.put(`/api/admin/movies/${movieId}`, movieData);
            alert('Cập nhật phim thành công!');
            console.log('Thông tin phim đã cập nhật:', response.data);
        } catch (error) {
            console.error('Lỗi khi cập nhật phim:', error);

            if (error.response?.status === 401) {
                if (window.confirm('Phiên đăng nhập đã hết hạn. Bạn có muốn đăng nhập lại không?')) {
                    window.location.href = '/dangnhap-dangky';
                }
            } else if (error.response?.status === 400 && typeof error.response.data === 'object') {
                const errors = error.response.data;
                const firstKey = Object.keys(errors)[0];
                alert(errors[firstKey]);
                const el = document.getElementById(firstKey);
                if (el) el.focus();
            } else {
                const errorMessage = error.response?.data?.message || error.message || 'Đã có lỗi xảy ra khi cập nhật phim.';
                alert('Lỗi: ' + errorMessage);
            }
        } finally {
            updateBtn.disabled = false;
            updateBtn.textContent = 'Cập nhật phim';
        }
    }
    document.getElementById('updateMovieBtn').addEventListener('click', handleUpdateMovie);

</script>


<script>
    $(function() { // Đảm bảo DOM sẵn sàng

        const thumbnailInput = document.getElementById('thumbnail-input');
        const thumbnailPreview = document.getElementById('thumbnail');
        const thumbnailPlaceholder = document.getElementById('thumbnail-placeholder');
        const uploadLabel = document.getElementById('thumbnail-upload-label');
        const uploadStatus = document.getElementById('upload-status');
        const hiddenThumbnailUrlInput = document.getElementById('thumbnail-url-hidden'); // Input ẩn để lưu URL
console.log(thumbnailInput, thumbnailPreview, thumbnailPlaceholder, uploadLabel, uploadStatus, hiddenThumbnailUrlInput)
        if (!thumbnailInput || !thumbnailPreview || !uploadLabel || !uploadStatus || !hiddenThumbnailUrlInput) {
            console.error("Một hoặc nhiều thành phần DOM *thiết yếu* cho upload thumbnail bị thiếu! (Input, Preview, Label, Status, Hidden URL)");
            return; // Dừng nếu thiếu element quan trọng
        }


        thumbnailInput.addEventListener('change', function(event) {
            const files = event.target.files;

            if (files && files.length > 0) {
                const selectedFile = files[0];

                // --- 1. Kiểm tra loại file ---
                if (!selectedFile.type.startsWith('image/')) {
                    alert('Vui lòng chỉ chọn file hình ảnh (JPEG, PNG, GIF, ...).');
                    thumbnailInput.value = ''; // Xóa lựa chọn file không hợp lệ
                    return;
                }

                // --- 2. Hiển thị Xem trước (Preview) ---
                const reader = new FileReader();

                reader.onload = function(e) {
                    // Cập nhật ảnh xem trước
                    thumbnailPreview.src = e.target.result;
                    thumbnailPreview.style.display = 'block'; // Hiển thị ảnh
                    if(thumbnailPlaceholder) thumbnailPlaceholder.style.display = 'none'; // Ẩn placeholder
                }

                // Đọc file dưới dạng Data URL để xem trước
                reader.readAsDataURL(selectedFile);

                // --- 3. Gọi API Upload ngay sau khi chọn file ---
                uploadFile(selectedFile);

            } else {
                // Người dùng hủy chọn file (ít xảy ra với change event nhưng để chắc chắn)
                console.log("Không có file nào được chọn.");
            }
        });

        async function uploadFile(fileToUpload) {
            // Lấy Movie ID (cần đảm bảo biến 'movie' tồn tại và có 'id')
            const movieId = movie?.id;
            if (!movieId) {
                alert('Lỗi: Không xác định được ID phim để upload ảnh.');
                uploadStatus.textContent = 'Lỗi: Thiếu ID phim.';
                uploadStatus.style.color = 'red';
                thumbnailInput.value = ''; // Reset input
                return;
            }

            // Chuẩn bị FormData
            const formData = new FormData();
            formData.append('file', fileToUpload); // 'file' phải khớp với @RequestParam("file") ở backend

            // Cập nhật trạng thái giao diện người dùng
            uploadLabel.classList.add('disabled'); // Làm mờ nút (thêm CSS nếu cần)
            uploadLabel.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Đang tải lên...';
            thumbnailInput.disabled = true;
            uploadStatus.textContent = 'Đang tải ảnh lên server...';
            uploadStatus.style.color = '#007bff'; // Màu xanh dương

            try {
                const apiUrl = `/api/admin/movies/${movieId}/upload-thumbnail`;
                console.log(`Gọi API POST: ${apiUrl}`);

                // Gọi API bằng Axios (hoặc Fetch)
                const response = await axios.post(apiUrl, formData, {
                    headers: {
                        // 'Content-Type': 'multipart/form-data' // Axios tự động đặt header này cho FormData
                    }
                });

                console.log("Upload thành công, response:", response.data);

                if (response.data && response.data.url) {
                    const newImageUrl = response.data.url;
                    alert('Upload hình ảnh thành công!');
                    uploadStatus.textContent = 'Upload thành công!';
                    uploadStatus.style.color = 'green';

                    // Cập nhật ảnh preview bằng URL thật từ Cloudinary (tùy chọn)
                    thumbnailPreview.src = newImageUrl;

                    // Lưu URL mới vào input ẩn (quan trọng nếu cần gửi đi sau này)
                    if (hiddenThumbnailUrlInput) {
                        hiddenThumbnailUrlInput.value = newImageUrl;
                        console.log("Đã cập nhật URL ảnh vào input ẩn:", newImageUrl);
                    }

                } else {
                    throw new Error("API không trả về URL hợp lệ."); // Xử lý lỗi nếu response không đúng format
                }

            } catch (error) {
                console.error("Lỗi khi upload hình ảnh:", error);
                let errorMsg = "Upload ảnh thất bại. ";
                if (error.response) {
                    // Lỗi từ server (4xx, 5xx)
                    errorMsg += `Lỗi ${error.response.status}: ${error.response.data?.message || error.response.data || 'Không rõ nguyên nhân từ server.'}`;
                } else if (error.request) {
                    // Không nhận được phản hồi
                    errorMsg += "Không thể kết nối tới server.";
                } else {
                    // Lỗi khác
                    errorMsg += error.message;
                }
                alert(errorMsg);
                uploadStatus.textContent = 'Upload thất bại.';
                uploadStatus.style.color = 'red';

                // Cân nhắc: Có nên reset ảnh preview về ảnh cũ nếu upload lỗi?
                // Hoặc giữ nguyên ảnh preview mà người dùng đã chọn?
                // Ví dụ: Reset về ảnh cũ (nếu có lưu trong input ẩn)
                // const oldUrl = hiddenThumbnailUrlInput ? hiddenThumbnailUrlInput.value : '';
                // thumbnailPreview.src = oldUrl;
                // if (!oldUrl && thumbnailPlaceholder) {
                //     thumbnailPreview.style.display = 'none';
                //     thumbnailPlaceholder.style.display = 'block';
                // }

            } finally {
                // Luôn luôn kích hoạt lại input và label sau khi hoàn tất
                thumbnailInput.disabled = false;
                uploadLabel.classList.remove('disabled');
                uploadLabel.innerHTML = '<i class="fas fa-upload mr-1"></i> Chọn hoặc đổi ảnh';

                // Xóa trạng thái upload sau một khoảng thời gian
                setTimeout(() => {
                    uploadStatus.textContent = '';
                }, 5000); // Xóa sau 5 giây
            }
        }
    });
</script>
</body>

</html>