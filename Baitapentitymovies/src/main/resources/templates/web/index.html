<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" th:href="@{/css/styler.css}"/>
 
</head>
  <body>
    <header>
      <nav class="navbar navbar-expand-lg bg-dark ">
        <div class="container text-white">
          <a class="navbar-brand" href="#"> <img
                            src="https://movie.techmaster.vn/assets/logo-C2IIl7EL.png"
                            alt="logo"/></a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse " id="navbarNavDropdown">
            <ul class="navbar-nav">
              <li class="nav-item ">
                <a class="nav-link active text-white" aria-current="page" th:href="@{/}">Trang chủ</a>
              </li>
              <li class="nav-item">
                <a class="nav-link text-white" th:href="@{/phim-bo}">Phim bộ</a>
              </li>
              <li class="nav-item">
                <a class="nav-link text-white" th:href="@{/phim-chieu-rap}">Phim chiếu rạp</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link text-white"  th:href="@{/phim-le}">Phim lẻ</a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                 Quốc gia
                </a>
                <ul class="dropdown-menu text-white">
                  <li><a class="dropdown-item" href="#">Action</a></li>
                  <li><a class="dropdown-item" href="#">Another action</a></li>
                  <li><a class="dropdown-item" href="#">Something else here</a></li>
                </ul>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Thể loại
                </a>
                <ul class="dropdown-menu text-white">
                  <li><a class="dropdown-item" href="#">Action</a></li>
                  <li><a class="dropdown-item" href="#">Another action</a></li>
                  <li><a class="dropdown-item" href="#">Something else here</a></li>
                </ul>
              </li>
              <li class="nav-item">
                <a class="nav-link text-white" href="#">Mua phim</a>
              </li>
            </ul>
          </div>
            <div>
                <!-- Liên kết Đăng nhập khi chưa đăng nhập - Sẽ được ẩn/hiện bằng JavaScript -->
                <a id="nav-login-link" class="nav-link ju text-white" th:href="@{/dangnhap-dangky}">Đăng nhập</a>

                <!-- Dropdown thông tin người dùng khi đã đăng nhập - Ban đầu ẩn, JS sẽ hiện -->
                <div class="dropdown" id="nav-user-dropdown" style="display: none;">
                    <button id="user-dropdown-button" class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <!-- Tên người dùng sẽ được JS điền vào đây -->
                        Xin chào
                    </button>
                    <ul class="dropdown-menu">
                        <!-- Link trang quản trị - JS sẽ ẩn/hiện dựa trên role từ token -->
                        <li><a id="admin-page-link" class="dropdown-item" href="#" style="display: none;">Trang quản trị</a></li>
                        <li><a class="dropdown-item" th:href="@{/phim-yeu-thich}">Phim yêu thích</a></li>
                        <li><a class="dropdown-item" href="#">Hồ sơ cá nhân</a></li>
                        <li>
                            <!-- ID cho link đăng xuất để JS gắn sự kiện -->
                            <a id="logout-link-homepage" class="dropdown-item" href="#">Đăng xuất</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
          </div>
      </nav>
    </header>

    <section class="py-4 bg-body-tertiary">
        <div class="container">
            <h4 class="mb-3 mt-3">Phim HOT</h4>
            <div class="row">
                <div class="col-3" th:each="movie : ${moviePage}">
                    <a class="text-decoration-none text-dark"
                       th:href="@{/phim/{id}/{slug}(id=${movie.getId()}, slug=${movie.getSlug()})}">
                    <div class="movie-poster rounded overflow-hidden position-relative">
                            <p class="phimle" th:text="${movie.type}">Loại phim</p>
                            <img th:src="${movie.thumbnail}" th:alt="${movie.name}">
                        </div>
                            <div class="movie-info">
                                <p class="mt-3 mb-0" th:text="${movie.getName()}">Tên phim</p>
                            </div>
                       
                    </a>
                </div>
            </div>
        </div>
    </section>

    <section class="py-4 ">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h4>Phim lẻ mới cập nhật</h4>
          <a href="phim-le">Xem thêm</a>
      </div>
        <div class="row">
          <div class="col-2" th:each="movie : ${phimLeList}">
              <a class="text-decoration-none text-dark"  th:href="@{/phim/{id}/{slug}(id=${movie.getId()}, slug=${movie.getSlug()})}">
                  <div class="movie-poster rounded overflow-hidden position-relative">

                      <img th:src="${movie.thumbnail}" th:alt="${movie.name}">
                  </div>
                      <div class="movie-info">
                          <p class="mt-3 mb-0" th:text="${movie.getName()}"></p>
                      </div>

              </a>
                </div>
            </div>
        </div>
    </section>
    <section class="py-4 bg-body-tertiary">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h4>Phim bộ mới cập nhật</h4>
          <a href="phim-bo">Xem thêm</a>
      </div>
        <div class="row">
            <div class="col-2" th:each="movie : ${phimBoList}">
                <a class="text-decoration-none text-dark"  th:href="@{/phim/{id}/{slug}(id=${movie.getId()}, slug=${movie.getSlug()})}">
                    <div class="movie-poster rounded overflow-hidden position-relative">

                        <img th:src="${movie.thumbnail}" th:alt="${movie.name}">
                        </div>
                        <div class="movie-info">
                            <p class="mt-3 mb-0" th:text="${movie.getName()}"></p>
                        </div>

                </a>
            </div>
  </div>
    
    </div>
    </section>
    <section class="py-4">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h4>Phim chiếu rạp mới cập nhậtnhật</h4>
          <a href="phim-chieu-rap">Xem thêm</a>
      </div>
        <div class="row">
          <div class="col-2" th:each="movie : ${phimChieuRapList}" >
              <a class="text-decoration-none text-dark"  th:href="@{/phim/{id}/{slug}(id=${movie.getId()}, slug=${movie.getSlug()})}">
            <div class="movie-item">
                <div class="movie-poster rounded overflow-hidden position-relative">
                    <img th:src="${movie.thumbnail}" th:alt="${movie.name}">
                </div>
                <div class="movie-info">
                    <p class="mt-3 mb-0" th:text="${movie.getName()}"></p>
                </div>
            </div>
              </a>
        </div>


        

          </div>

    
    </div>
    </section>



    <section class="py-4">
        <div class="container">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <h4 class="mb-0 w-75">Tin tức</h4>
                <a class="text-primary text-decoration-none" th:href="@{/tin-tuc}">Xem thêm</a>
            </div>
            <div class="row">
                <div class="col-6" th:each="post : ${tinTuc}">
                    <div class="blog-item bg-body-tertiary rounded mb-4 overflow-hidden">
                        <a class="d-flex flex-column flex-md-row text-decoration-none" th:href="'/chi-tiet-tin-tuc/' + ${post.getId()}">
                            <div class="blog-thumbnail col-4">
                                <img th:src="${post.thumbnail}" alt="Top 10 phim Zombie (xác sống) hay nhất trên màn hình ảnh">
                            </div>
                            <div class="blog-info p-1 p-md-3 col-8">
                                <h5 class="text-truncate" th:text="${post.getTitle()}">Top 10 phim Zombie (xác sống) hay nhất trên màn hình ảnh</h5>
                                <p class="fst-italic mb-3 " th:text="${post.getUpdatedAt()}" >th>25/03/2025</p>
                                <p class="mb-0 truncate" th:text="${post.getContent()}">Ví MoMo hạnh phúc mang đến danh sách các phim zombie hay nhất trên màn hình sẽ tạo ra các fan phim xác sống chung đam mê nhé.</p>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>\
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script th:src="@{/javascrip/dangnhapdangky.js}"></script>
    <!-- ... các script Bootstrap và Axios đã có ... -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <!-- Script dangnhapdangky.js (chứa interceptor và các hàm login/logout chung) NÊN được tải trước -->
    <script th:src="@{/javascrip/dangnhapdangky.js}"></script>

    <!-- SCRIPT RIÊNG CHO TRANG CHỦ (INDEX.HTML) ĐỂ CẬP NHẬT NAVBAR -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const token = localStorage.getItem('jwtToken');

            // Lấy các phần tử Navbar
            const navLoginLink = document.getElementById('nav-login-link');
            const navUserDropdown = document.getElementById('nav-user-dropdown');
            const userDropdownButton = document.getElementById('user-dropdown-button');
            const adminPageLink = document.getElementById('admin-page-link');
            const logoutLinkHomepage = document.getElementById('logout-link-homepage'); // Logout link trên trang chủ

            const LOGIN_PAGE_URL = "/dangnhap-dangky"; // URL trang đăng nhập
            const ADMIN_DASHBOARD_URL = "/admin/dashboard"; // URL trang quản trị của bạn

            // Hàm giải mã JWT cơ bản (chỉ lấy payload, không xác thực chữ ký ở client)
            // Bạn NÊN có hàm này trong một file util chung nếu dùng ở nhiều nơi
            function decodeJwtToken(tokenToDecode) {
                if (!tokenToDecode) return null;
                try {
                    const base64Url = tokenToDecode.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    return JSON.parse(jsonPayload);
                } catch (e) {
                    console.error("Error decoding JWT token:", e);
                    localStorage.removeItem('jwtToken'); // Xóa token hỏng
                    return null;
                }
            }

            function updateUserNavbar() {
                if (token) {
                    // Người dùng đã đăng nhập (có token)
                    if (navLoginLink) navLoginLink.style.display = 'none';
                    if (navUserDropdown) navUserDropdown.style.display = 'block'; // Hiện dropdown user

                    const decodedToken = decodeJwtToken(token);
                    if (decodedToken) {
                        console.log("Decoded Token on Homepage:", decodedToken);
                        // 'sub' thường là email/username. 'roles' hoặc 'role' là vai trò.
                        // 'name' hoặc 'fullName' nếu bạn thêm vào claims.
                        const displayName = decodedToken.name || decodedToken.fullName || decodedToken.sub || "Người dùng";
                        const userRole = decodedToken.roles || decodedToken.role; // Kiểm tra cả 'roles' và 'role'

                        if (userDropdownButton) userDropdownButton.textContent = `Xin chào, ${displayName}`;

                        // Hiển thị link "Trang quản trị" nếu là ADMIN
                        if (adminPageLink && userRole && userRole.toUpperCase() === 'ADMIN') {
                            adminPageLink.style.display = 'block'; // Hoặc 'list-item' nếu là <li>
                            adminPageLink.href = ADMIN_DASHBOARD_URL;
                        } else if (adminPageLink) {
                            adminPageLink.style.display = 'none';
                        }
                    } else {
                        // Token không giải mã được hoặc không có thông tin cần thiết
                        // Xử lý như chưa đăng nhập
                        if (navLoginLink) navLoginLink.style.display = 'block';
                        if (navUserDropdown) navUserDropdown.style.display = 'none';
                        if (userDropdownButton) userDropdownButton.textContent = "Xin chào";
                        if (adminPageLink) adminPageLink.style.display = 'none';
                    }

                    // Gắn sự kiện cho nút đăng xuất trên trang chủ
                    // Đảm bảo rằng hàm handleLogout từ dangnhapdangky.js có thể truy cập được
                    // hoặc định nghĩa lại logic logout ở đây.
                    if (logoutLinkHomepage && typeof handleLogout === 'function') {
                        // Nếu handleLogout đã được định nghĩa global từ dangnhapdangky.js
                        logoutLinkHomepage.addEventListener('click', handleLogout);
                    } else if (logoutLinkHomepage) {
                        // Hoặc định nghĩa logic logout cơ bản ngay tại đây
                        logoutLinkHomepage.addEventListener('click', async function(event) {
                            event.preventDefault();
                            if (!confirm("Bạn có chắc chắn muốn đăng xuất?")) {
                                return;
                            }
                            try {
                                // Gọi API logout của backend (nếu có logic đặc biệt như blacklist token)
                                // const apiToken = localStorage.getItem('jwtToken'); // Lấy token hiện tại
                                // if(apiToken) {
                                //    await axios.post("/api/auth/logout", {}, { headers: {'Authorization': `Bearer ${apiToken}`}});
                                // }
                                localStorage.removeItem('jwtToken');
                                console.log("Token removed, logging out from homepage.");
                                alert('Đăng xuất thành công!');
                                window.location.href = LOGIN_PAGE_URL; // Điều hướng về trang đăng nhập
                            } catch (err) {
                                console.error("Logout error on homepage:", err);
                                alert('Đã xảy ra lỗi khi đăng xuất. Vui lòng thử lại.');
                                // Dù lỗi server, vẫn xóa token và điều hướng
                                localStorage.removeItem('jwtToken');
                                window.location.href = LOGIN_PAGE_URL;
                            }
                        });
                    }

                } else {
                    // Người dùng chưa đăng nhập (không có token)
                    if (navLoginLink) navLoginLink.style.display = 'block';
                    if (navUserDropdown) navUserDropdown.style.display = 'none';
                }
            }

            updateUserNavbar(); // Gọi hàm để cập nhật UI Navbar khi trang tải xong

            // (Tùy chọn) Lắng nghe sự kiện thay đổi storage từ các tab khác
            window.addEventListener('storage', function(event) {
                if (event.key === 'jwtToken') {
                    // console.log("Token changed in another tab/window. Updating navbar.");
                    // Cập nhật lại UI nếu token thay đổi ở tab khác (đăng nhập/đăng xuất ở tab khác)
                    // Cần cẩn thận để tránh gọi lại updateUserNavbar nếu không cần thiết hoặc gây vòng lặp
                    // Cách đơn giản nhất là reload lại trang để lấy trạng thái mới nhất
                    window.location.reload();
                }
            });
        });
    </script>
  </body>
</html>
  </body>
</html>